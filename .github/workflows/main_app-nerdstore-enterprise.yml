name: CI/CD – Pipeline Corporativo Completo (.NET Core 3.1)

on:
  push:
    branches: [ "main", "develop", "release/*" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  PROJECT_PATH: "src/NSE.WebApp.MVC/NSE.WebApp.MVC.csproj"
  BUILD_CONFIGURATION: "Release"
  ARTIFACT_NAME: "nerdstore-artifact"

permissions:
  contents: read

jobs:
  # ==================================================
  #                    CI – Build
  # ==================================================
  build:
    name: Build Solution (.NET Core 3.1)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET Core 3.1
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "3.1.x"

      - name: Restore dependencies
        run: dotnet restore $PROJECT_PATH

      - name: Build
        run: dotnet build $PROJECT_PATH --configuration $BUILD_CONFIGURATION --no-restore

  # ==================================================
  #                    CI – Testes
  # ==================================================
  tests:
    name: Execute Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET Core 3.1
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "3.1.x"

      - name: Run Unit Tests
        run: dotnet test --no-build --verbosity normal


  # ==================================================
  #         CI – Static Analysis / Security Scan
  # ==================================================
  security-scan:
    name: Security & Code Quality Scan
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Escaneamento básico de vulnerabilidades
      - name: Run Dependency Vulnerability Scan
        uses: github/codeql-action/init@v3
        with:
          languages: csharp

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3


  # ==================================================
  #            CI – Publish / Package Artifacts
  # ==================================================
  package:
    name: Package Application for Deployment
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET Core 3.1
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "3.1.x"

      - name: Publish app
        run: dotnet publish $PROJECT_PATH -c $BUILD_CONFIGURATION -o ./published

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./published


  # ==================================================
  #                    CD – Deploy DEV
  # ==================================================
  deploy-dev:
    name: Deploy to DEV Environment
    runs-on: ubuntu-latest
    needs: package

    environment:
      name: dev

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./published

      - name: Deploy to Azure Web App (DEV)
        uses: azure/webapps-deploy@v3
        with:
          app-name: "app-nerdstore-dev"
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_DEV }}
          package: ./published


  # ==================================================
  #                 CD – Deploy HML (Approval)
  # ==================================================
  deploy-hml:
    name: Deploy to HML Environment
    runs-on: ubuntu-latest
    needs: deploy-dev

    environment:
      name: hml
      url: https://app-nerdstore-hml.azurewebsites.net
      # Bloqueio corporativo: aprovação obrigatória antes do deploy
      deployment_branch_policy:
        protected_branches: true

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./published

      - name: Deploy to Azure Web App (HML)
        uses: azure/webapps-deploy@v3
        with:
          app-name: "app-nerdstore-hml"
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_HML }}
          package: ./published


  # ==================================================
  #                CD – Deploy PROD (Approval)
  # ==================================================
  deploy-prod:
    name: Deploy to PROD Environment (Controlled Release)
    runs-on: ubuntu-latest
    needs: deploy-hml

    environment:
      name: production
      url: https://app-nerdstore-prod.azurewebsites.net
      # Gate corporativo de aprovação antes do deploy
      deployment_branch_policy:
        protected_branches: true

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./published

      - name: Deploy to Azure Web App (PROD)
        uses: azure/webapps-deploy@v3
        with:
          app-name: "app-nerdstore-prod"
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PROD }}
          package: ./published
